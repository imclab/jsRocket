/*! jsRocket - v0.0.1 - 2012-11-24
* https://github.com/mog/jsRocket
* Copyright (c) 2012 mog; Licensed MIT*/

function Websock(){"use strict";function l(){return o}function c(){return r}function h(){return i}function p(e){i=e}function d(){return r.length-i}function v(){return r[i]}function m(){return r[i++]}function g(e){i===0?r.unshift(e):(i-=1,r[i]=e)}function y(){return(r[i++]<<8)+r[i++]}function b(){return(r[i++]<<24)+(r[i++]<<16)+(r[i++]<<8)+r[i++]}function w(e){typeof e=="undefined"&&(e=d());var t=r.slice(i,i+e);return i+=e,String.fromCharCode.apply(null,t)}function E(e){return typeof e=="undefined"&&(e=d()),i+=e,r.slice(i-e,i)}function S(e,t){return t?r.slice(i+e,i+t):r.slice(i+e)}function x(e,t,n){var s=r.length-i;if(s<t){if(n){if(i<n)throw"rQwait cannot backup "+n+" bytes";i-=n}return!0}return!1}function T(){return n==="binary"?(new Uint8Array(o)).buffer:Base64.encode(o)}function N(e){n==="binary"?r.push.apply(r,new Uint8Array(e)):r=r.concat(Base64.decode(e,0))}function C(){return t.bufferedAmount!==0&&a.Debug("bufferedAmount: "+t.bufferedAmount),t.bufferedAmount<e.maxBufferedAmount?(o.length>0&&(t.send(T(o)),o=[]),!0):(a.Info("Delaying send, bufferedAmount: "+t.bufferedAmount),!1)}function k(e){return o=o.concat(e),C()}function L(t){e.send(t.split("").map(function(e){return e.charCodeAt(0)}))}function A(e){try{N(e.data),d()>0?(u.message(),r.length>s&&(r=r.slice(i),i=0)):a.Debug("Ignoring empty message")}catch(t){typeof t.stack!="undefined"?a.Warn("recv_message, caught exception: "+t.stack):typeof t.description!="undefined"?a.Warn("recv_message, caught exception: "+t.description):a.Warn("recv_message, caught exception:"+t),typeof t.name!="undefined"?u.error(t.name+": "+t.message):u.error(t)}}function O(e,t){u[e]=t}function M(e){r=[],i=0,o=[],t=null;var n=!1,s=!1,u=!1;"Uint8Array"in window&&"set"in Uint8Array.prototype&&(n=!0);try{n&&"binaryType"in new WebSocket("ws://localhost:17523")&&(a.Info("Detected binaryType support in WebSockets"),s=!0)}catch(f){}typeof e=="undefined"&&(s?e=["binary","base64"]:e="base64");if(!s){if(e==="binary")throw"WebSocket binary sub-protocol requested but not supported";if(typeof e=="object"){var l=[];for(var c=0;c<e.length;c++)e[c]==="binary"?a.Error("Skipping unsupported WebSocket binary sub-protocol"):l.push(e[c]);if(!(l.length>0))throw"Only WebSocket binary sub-protocol was requested and not supported.";e=l}}return e}function _(e,r){r=M(r),f?t={}:t=new WebSocket(e,r),t.onmessage=A,t.onopen=function(){a.Debug(">> WebSock.onopen"),t.protocol?(n=t.protocol,a.Info("Server chose sub-protocol: "+t.protocol)):(n="base64",a.Error("Server select no sub-protocol!: "+t.protocol)),n==="binary"&&(t.binaryType="arraybuffer"),u.open(),a.Debug("<< WebSock.onopen")},t.onclose=function(e){a.Debug(">> WebSock.onclose"),u.close(e),a.Debug("<< WebSock.onclose")},t.onerror=function(e){a.Debug(">> WebSock.onerror: "+e),u.error(e),a.Debug("<< WebSock.onerror")}}function D(){if(t){if(t.readyState===WebSocket.OPEN||t.readyState===WebSocket.CONNECTING)a.Info("Closing WebSocket connection"),t.close();t.onmessage=function(e){return}}}function P(t){return f=!0,e.send=t,e.close=function(){},A}function H(){return e.maxBufferedAmount=200,e.get_sQ=l,e.get_rQ=c,e.get_rQi=h,e.set_rQi=p,e.rQlen=d,e.rQpeek8=v,e.rQshift8=m,e.rQunshift8=g,e.rQshift16=y,e.rQshift32=b,e.rQshiftStr=w,e.rQshiftBytes=E,e.rQslice=S,e.rQwait=x,e.flush=C,e.send=k,e.send_string=L,e.on=O,e.init=M,e.open=_,e.close=D,e.testMode=P,e}var e={},t=null,n="base64",r=[],i=0,s=1e4,o=[],u={message:function(){},open:function(){},close:function(){},error:function(){}},a=JSRocket.Util,f=!1;return H()}var JSRocket={};(function(){"use strict";JSRocket.Util={},Array.prototype.push8=function(e){this.push(e&255)},Array.prototype.push16=function(e){this.push(e>>8&255,e&255)},Array.prototype.push32=function(e){this.push(e>>24&255,e>>16&255,e>>8&255,e&255)},Array.prototype.map||(Array.prototype.map=function(e){var t=this.length;if(typeof e!="function")throw new TypeError;var n=new Array(t),r=arguments[1];for(var i=0;i<t;i++)i in this&&(n[i]=e.call(r,this[i],i,this));return n}),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),JSRocket.Util._log_level="warn",JSRocket.Util.init_logging=function(e){typeof e=="undefined"?e=JSRocket.Util._log_level:JSRocket.Util._log_level=e,typeof window.console=="undefined"&&(typeof window.opera!="undefined"?window.console={log:window.opera.postError,warn:window.opera.postError,error:window.opera.postError}:window.console={log:function(e){},warn:function(e){},error:function(e){}}),JSRocket.Util.Debug=JSRocket.Util.Info=JSRocket.Util.Warn=JSRocket.Util.Error=function(e){};switch(e){case"debug":JSRocket.Util.Debug=function(e){console.log(e)};break;case"info":JSRocket.Util.Info=function(e){console.log(e)};break;case"warn":JSRocket.Util.Warn=function(e){console.warn(e)};break;case"error":JSRocket.Util.Error=function(e){console.error(e)};break;case"none":break;default:throw"invalid logging type '"+e+"'"}},JSRocket.Util.get_logging=function(){return JSRocket.Util._log_level},JSRocket.Util.init_logging(),JSRocket.Util.conf_default=function(e,t,n,r,i,s,o,u){var a,f;a=function(t){return s in{arr:1,array:1}&&typeof t!="undefined"?e[r][t]:e[r]},f=function(t,n){s in{"boolean":1,bool:1}?!t||t in{0:1,no:1,"false":1}?t=!1:t=!0:s in{integer:1,"int":1}?t=parseInt(t,10):s==="str"?t=String(t):s==="func"&&(t||(t=function(){})),typeof n!="undefined"?e[r][n]=t:e[r]=t},t[r+"_description"]=u,typeof t["get_"+r]=="undefined"&&(t["get_"+r]=a),typeof t["set_"+r]=="undefined"&&(t["set_"+r]=function(t,n){if(i in{RO:1,ro:1})throw r+" is read-only";if(i in{WO:1,wo:1}&&typeof e[r]!="undefined")throw r+" can only be set once";f(t,n)}),typeof n[r]!="undefined"?o=n[r]:s in{arr:1,array:1}&&!(o instanceof Array)&&(o=[]),f(o)},JSRocket.Util.conf_defaults=function(e,t,n,r){var i;for(i=0;i<r.length;i++)JSRocket.Util.conf_default(e,t,n,r[i][0],r[i][1],r[i][2],r[i][3],r[i][4])},JSRocket.Util.getPosition=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop,e=e.offsetParent;while(e);return{x:t,y:n}},JSRocket.Util.getEventPosition=function(e,t,n){var r,i,s,o;r=e?e:window.event,r=r.changedTouches?r.changedTouches[0]:r.touches?r.touches[0]:r;if(r.pageX||r.pageY)i=r.pageX,s=r.pageY;else if(r.clientX||r.clientY)i=r.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,s=r.clientY+document.body.scrollTop+document.documentElement.scrollTop;return o=JSRocket.Util.getPosition(t),typeof n=="undefined"&&(n=1),{x:(i-o.x)/n,y:(s-o.y)/n}},JSRocket.Util.addEvent=function(e,t,n){if(e.attachEvent){var r=e.attachEvent("on"+t,n);return r}if(e.addEventListener)return e.addEventListener(t,n,!1),!0;throw"Handler could not be attached"},JSRocket.Util.removeEvent=function(e,t,n){if(e.detachEvent){var r=e.detachEvent("on"+t,n);return r}if(e.removeEventListener)return e.removeEventListener(t,n,!1),!0;throw"Handler could not be removed"},JSRocket.Util.stopEvent=function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault?e.preventDefault():e.returnValue=!1},JSRocket.Util.Features={xpath:!!document.evaluate,air:!!window.runtime,query:!!document.querySelector},JSRocket.Util.Engine={presto:function(){return window.opera?!0:!1}(),trident:function(){return window.ActiveXObject?window.XMLHttpRequest?document.querySelectorAll?6:5:4:!1}(),webkit:function(){try{return navigator.taintEnabled?!1:JSRocket.Util.Features.xpath?JSRocket.Util.Features.query?525:420:419}catch(e){return!1}}(),gecko:function(){return!document.getBoxObjectFor&&window.mozInnerScreenX==null?!1:document.getElementsByClassName?19:18}()},JSRocket.Util.Engine.webkit&&(JSRocket.Util.Engine.webkit=function(e){var t=new RegExp("WebKit/([0-9\\.]*) ");return e=(navigator.userAgent.match(t)||["",e])[1],parseFloat(e,10)}(JSRocket.Util.Engine.webkit)),JSRocket.Util.Flash=function(){var e,t;try{e=navigator.plugins["Shockwave Flash"].description}catch(n){try{e=(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version")}catch(r){e="0 r0"}}return t=e.match(/\d+/g),{version:parseInt(t[0]||"0."+t[1],10)||0,build:parseInt(t[2],10)||0}}()})(),window.WebSocket&&!window.WEB_SOCKET_FORCE_FLASH?Websock_native=!0:window.MozWebSocket&&!window.WEB_SOCKET_FORCE_FLASH&&(Websock_native=!0,window.WebSocket=window.MozWebSocket),JSRocket.SyncData=function(){"use strict";function t(t){return e[t]}function n(t){for(var n=0;n<e.length;n++)if(e[n].name===t)return n;return-1}function r(){return e.length}function i(t){var n=new JSRocket.Track;n.name=t,e.push(n)}var e=[];return{getTrack:t,getIndexForName:n,getTrackLength:r,createIndex:i}},JSRocket.Track=function(){"use strict";function o(s){var o=Math.floor(s),a=u(o),f=a.low,l=a.high,c;if(isNaN(f))return NaN;if(isNaN(l)||i[f].interpolation===e)return i[f].value;switch(i[f].interpolation){case t:return c=(s-f)/(l-f),i[f].value+(i[l].value-i[f].value)*c;case n:return c=(s-f)/(l-f),c=c*c*(3-2*c),i[l].value*c+i[f].value*(1-c);case r:return c=Math.pow((s-f)/(l-f),2),i[f].value+(i[l].value-i[f].value)*c}return NaN}function u(e){var t=NaN,n=NaN;for(var r=0;r<s.length;r++)if(s[r]<=e)t=s[r];else if(s[r]>=e){n=s[r];break}return{low:t,high:n}}function a(e,t,n){f(e),s.push(e),i[e]={value:t,interpolation:n},s=s.sort(function(e,t){return e-t})}function f(e){s.indexOf(e)>-1&&(s.splice(s.indexOf(e),1),delete i[e])}var e=0,t=1,n=2,r=3,i=[],s=[];return{getValue:o,add:a,remove:f}},JSRocket.SyncDevicePlayer=function(e){"use strict";function i(e){t=new XMLHttpRequest;if(t===null){r.error();return}t.open("GET",e,!0),t.onreadystatechange=s,t.send()}function s(){t.readyState===4&&(t.status<300?o(t.responseText):r.error())}function o(e){var t=(new DOMParser).parseFromString(e,"text/xml"),n=t.getElementsByTagName("tracks");for(var i=0;i<n.length;i++){var s=n[i].getElementsByTagName("track");for(var o=0;o<s.length;o++){var a=u(s[o].getAttribute("name")),f=s[o].getElementsByTagName("key");for(var l=0;l<f.length;l++)a.add(parseInt(f[l].getAttribute("row"),10),parseFloat(f[l].getAttribute("value")),parseInt(f[l].getAttribute("interpolation"),10))}}r.ready()}function u(e){var t=n.getIndexForName(e);return t>-1?n.getTrack(t):(n.createIndex(e),n.getTrack(n.getTrackLength()-1))}function a(e,t){r[e]=t}function f(){}var t,n=new JSRocket.SyncData,r={ready:function(){},error:function(){}};if(e.rocketXML===""||e.rocketXML===undefined||e.rocketXML===undefined)throw"[jsRocket] rocketXML is not set, try _syncDevice.setConfig({'rocketXML':'url/To/RocketXML.rocket'})";return i(e.rocketXML),{load:i,getTrack:u,update:f,on:a}},JSRocket.SyncDeviceClient=function(e){"use strict";function p(){l.send_string("hello, synctracker!")}function d(){var e=l.rQshiftBytes();f=f.concat(e),v()}function v(){var e=f.length,r,l,p,d;a===-1&&(a=f[0]),a===104&&e>=12?(f=[],a=-1,h.ready()):s===a&&e>=2?(p=parseInt(f[1],10),f=f.slice(2),a=-1,p===1?h.pause():h.play()):i===a&&e>=5?(l=w(f.slice(1,5)),f=f.slice(5),a=-1,h.update(l)):t===a&&e>=14?(r=w(f.slice(1,5)),l=w(f.slice(5,9)),p=parseInt(Math.round(E(f.slice(9,13))*1e3)/1e3,10),d=parseInt(f.slice(13,14).join(""),10),c.getTrack(r).add(l,p,d),f=f.slice(14),a=-1,h.update()):n===a&&e>=9?(r=w(f.slice(1,5)),l=w(f.slice(5,9)),c.getTrack(r).remove(l),f=f.slice(9),a=-1,h.update(l)):o===a&&(f=f.slice(1),a=-1),clearInterval(u),f.length>=2&&(u=setInterval(v,1))}function m(){}function g(){}function y(e){var t=c.getIndexForName(e);return t>-1?c.getTrack(t):(l.send([r,0,0,0,c.getTrackLength(),0,0,0,e.length]),l.send_string(e),l.flush(),c.createIndex(e),c.getTrack(c.getTrackLength()-1))}function b(e){l.send([i,0,0,0,e]),l.flush()}function w(e){var t=0,n=e.length-1;for(;n>0;n--)t+=parseInt(e[n],10)*Math.pow(256,e.length-1-n);return t}function E(e){var t=0,n=(e[t++]<<24)+(e[t++]<<16)+(e[t++]<<8)+e[t++],r=(n>>31)*2+1,i=n>>>23&255,s=n&8388607;return i===255?s?NaN:r*Infinity:(i?(i-=127,s|=8388608):i=-126,r*s*Math.pow(2,i-23))}function S(e,t){h[e]=t}var t=0,n=1,r=2,i=3,s=4,o=5,u,a=-1,f=[],l=new Websock,c=new JSRocket.SyncData,h={ready:function(){},update:function(){},play:function(){},pause:function(){}};return l.open(e.socketURL),l.on("open",p),l.on("message",d),l.on("close",m),l.on("error",g),{getTrack:y,update:b,on:S}},JSRocket.SyncDevice=function(){"use strict";function s(e){e==="demo"?t=new JSRocket.SyncDevicePlayer(r):t=new JSRocket.SyncDeviceClient(r),t.on("ready",a),t.on("update",f),t.on("play",l),t.on("pause",c)}function o(){return r}function u(e){for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}function a(){e=!0,i.ready()}function f(e){i.update(e)}function l(){i.play()}function c(){i.pause()}function h(n){return e?t.getTrack(n):null}function p(e){Math.floor(e)!==n&&(n=Math.floor(e),t.update(n))}function d(e,t){i[e]=t}var e=!1,t,n,r={socketURL:"ws://localhost:8080",rocketXML:""},i={ready:function(){},update:function(){},play:function(){},pause:function(){}};return{init:s,setConfig:u,getConfig:o,getTrack:h,update:p,on:d}};